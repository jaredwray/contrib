name: deploy-to-dev

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.DEV_GCP_PROJECT_ID }}
  SERVICE_NAME: contrib-app

  #Server Env
  ENV_NEW_RELIC_APP_NAME: contrib-app-dev
  ENV_NEW_RELIC_LICENSE_KEY: ${{ secrets.NEW_RELIC_LICENSE_KEY }}
  ENV_MONGODB_URI: ${{ secrets.DEV_MONGODB_URI }}
  ENV_TWILIO_ACCOUNT_SID: ACd64357f20d26725ac0b45616048e8d84
  ENV_TWILIO_AUTH_TOKEN: ${{ secrets.DEV_TWILIO_AUTH_TOKEN }}
  ENV_TWILIO_VERIFICATION_SERVICE_SID: ${{ secrets.DEV_TWILIO_VERIFICATION_SERVICE_SID }}
  ENV_AUTH_API_URL: https://dev.contrib.org/
  ENV_GOOGLE_CLIENT_ID: ${{ secrets.DEV_GOOGLE_CLIENT_ID }}
  ENV_GOOGLE_CLIENT_SECRET: ${{ secrets.DEV_GOOGLE_CLIENT_SECRET }}
  ENV_FACEBOOK_APP_ID: ${{ secrets.DEV_FACEBOOK_APP_ID }}
  ENV_FACEBOOK_APP_SECRET: ${{ secrets.DEV_FACEBOOK_APP_SECRET }}
  ENV_TWITTER_CONSUMER_KEY: ${{ secrets.DEV_TWITTER_CONSUMER_KEY }}
  ENV_TWITTER_CONSUMER_SECRET: ${{ secrets.DEV_TWITTER_CONSUMER_SECRET }}
  ENV_COOKIE_KEY_SECRET: ${{ secrets.DEV_COOKIE_KEY_SECRET }}
  ENV_COOKIE_LIFE_TIME_MINS: 7243
  ENV_APP_URL: "https://dev.contrib.org/"
  ENV_TWILIO_SENDER_NUMBER: +17726178791
  ENV_CONTENT_STORAGE_NAME: content-dev.contrib.org
  ENV_CONTENT_STORAGE_KEY: ${{ secrets.DEV_CONTENT_STORAGE_KEY }}
  ENV_UPS_DELIVERY_REQUEST_HEADER: ${{ secrets.DEV_UPS_DELIVERY_REQUEST_HEADER }}
  ENV_UPS_DELIVERY_CONTRIB_DATA: ${{ secrets.DEV_UPS_DELIVERY_CONTRIB_DATA }}
  ENV_UPS_AUCTION_DEFAULT_PARCEL_PARAMETERS: ${{ secrets.DEV_UPS_AUCTION_DEFAULT_PARCEL_PARAMETERS }}
  ENV_UPS_TEST_ENVIROMENT: true
  ENV_UPS_SMS_WITH_DELIVERY_LINK: true
  ENV_AUCTION_SCHEDULER_SECRET: ${{ secrets.DEV_AUCTION_SCHEDULER_SECRET }}
  ENV_CLOUDFLARE_STREAMING_KEY: ${{ secrets.DEV_CLOUDFLARE_STREAMING_KEY }}
  ENV_CLOUDFLARE_USER_ID: ${{ secrets.DEV_CLOUDFLARE_USER_ID }}
  ENV_STRIPE_SECRET_KEY: ${{ secrets.DEV_STRIPE_SECRET_KEY }}
  ENV_STRIPE_WEBHOOK_SECRET_KEY: ${{ secrets.DEV_STRIPE_WEBHOOK_SECRET_KEY }}
  ENV_STRIPE_CONTRIB_SHARE_PERCENTAGE: ${{ secrets.DEV_STRIPE_CONTRIB_SHARE_PERCENTAGE }}
  ENV_MAX_SIZE_VIDEO_GB: 0.2
  ENV_GOOGLE_CLOUD_PROJECT: contrib-dev
  ENV_GOOGLE_CLOUD_LOCATION: us-central1
  ENV_GOOGLE_CLOUD_TASK_QUEUE: bids-notification
  ENV_GOOGLE_CLOUD_TASK_API_TOKEN: ${{ secrets.DEV_GOOGLE_CLOUD_TASK_API_TOKEN }}
  ENV_NOTIFICATION_TASK_TARGET_URL: api/v1/notification

jobs:
  setup-build-deploy:
    name: Build and Deploy to Dev
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      # Setup Node
      - name: Use Node.js 14
        uses: actions/setup-node@v1
        with:
          node-version: 14

      # Build Client
      - name: Build Client
        run: yarn build-client
        env:
          REACT_APP_PLATFORM_URL: "https://dev.contrib.org/"
          REACT_APP_API_URL: "https://dev.contrib.org/graphql"
          REACT_APP_API_AUDIENCE: "https://dev.contrib.org"
          REACT_APP_USE_NEWRELIC: true
          REACT_APP_STRIPE_PUBLISHABLE_KEY: ${{ secrets.DEV_REACT_APP_STRIPE_PUBLISHABLE_KEY }}
          REACT_APP_INTERCOM_APP_ID: ${{ secrets.DEV_REACT_APP_INTERCOM_APP_ID }}
          REACT_APP_FULLSTORY_ORG_ID: ${{ secrets.DEV_REACT_APP_FULLSTORY_ORG_ID }}
          REACT_APP_MAX_SIZE_VIDEO_GB: 0.2
          REACT_APP_GOOGLE_ANALYTICS_APP_ID: "G-0VZJ4JNXP0"
          REACT_APP_SMARTLOOK_ID: ${{ secrets.DEV_REACT_APP_SMARTLOOK_ID }}
          REACT_APP_UPS_SHOW_LINK_ON_THE_AUCTION_PAGE: true

      # Test Client
      - name: Test Client
        run: yarn test-client

      # Build Server
      - name: Build Server
        run: yarn build-server

      # Test Server
      - name: Test Server
        run: yarn test-server

      - name: Code Coverage
        uses: codecov/codecov-action@v1.0.15
        with:
          token: ${{ secrets.CODECOV_KEY }}

      # Setup gcloud CLI
      - uses: google-github-actions/setup-gcloud@v0
        with:
          credentials_json:
            {
              "type": "service_account",
              "project_id": "contrib-dev",
              "private_key_id": "da2a20f17d88ee5f3a0f0dba58b5a591aa7431e3",
              "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC+9CaH40Vnd06Y\nbwXmBU7fTms8fb/qfKN0t3rdlXvDZJ70PptXo2BPc4yvY3H7BuhGJ9natsqTQl6j\n5AT/yfjDapNv7K/9V1OfBf4WnfgyEz8bnhD3Y56BSj+8/6FOUEe2TOR+a4qL6cwK\nDbnukqVvsJzu31/Ke+zSv5ZHSpyPoliMH6Sf7F9ZZ4qLujE9d/iwdwVJ0aSy//y+\nl/kUaSLx2PMXLyMm1Fqsg0DO0QHfx1wo/rgtUpioyoNSEi3QwDURMZlQnOD/dOAe\nnS+NOisIUNpWE+DUZ5aYFvr/YqmBpsHD+ZmvZfR/RQsi8zmfvuIwsYu5b6tvMjgV\ntWd1DGw1AgMBAAECggEAJoI1PQU7y2RXkM0e+ubKI6V8YcwYRnERQ6n22LXbKini\nFm6DxFY5x3wNfJdI9q9La06BFCb1zmG9lT6YNX9lL/+PsSwhx6zzO6gpOCVuVqbj\n/K1RTZqk7fzrwrEothLhi2WRVN9aJuIk2EgxXWfsfgw3ccLRXhPEzDF/3GuzDBH/\nqxWKoxNrCFglpqzJqxdo+/em8OPnOuVOz8AR/ZVWO7CR5D5jX3yVw2KeqGs8ALNg\nf8wDYx2UVQRHAuYKeONn8vnX+TTJfFpUbPijnAP6VeySsO9oCGQxJCICaZ0Lg5F3\nVRvpBLgTZOJThGDe23oW+HBilJMzN1f6aGPbkNxrBwKBgQDgKEUY7azLbjlPLdK1\nHzYUPsvxeHMikqZXPrk2Dsuirh9JhW75dbghTpvbJyWqPO0ZsTwlRKfDB78fBdLq\nYBQTb3kaCZRPGb+6zld5uXI7JWbTpUEW3ezXbX8hV/FTIuyrzANqwnY/z0dKk7G6\nrxW3cJpFOmR9s+Yf7oj0h2wN8wKBgQDaFGUfQyR8tWqbgJFK5u0eiUSEODTBKMtu\nD+zUSX13kSjX0XPGrRx4lxXpo7hP11FcN2xbC0gbphaTx4Ff9CgNZv7lvgu0Py4Q\nyRb4NE7v78v7QLMopV1I5fGluyvu5Q5sbIYi+0mZONMLOdZn36o2x0Ur6/k8k+LB\nxD9OZIcfNwKBgERDPzemObcB7CX2uHI7/QYRUZ5JphZjPpDXIyQZQV5bVF/ZaMBD\nXz2VaNVGiKvdPf9TABQBYm18UHGsHl0NwU9h5SlOvYGRP9gtumnxVZ45d6UAcF/8\nWYIJcGvBElbVDeoLiQbcDZLFFtrZO4i0hRKGEhT/AVdej7gttjtxejCNAoGBAJ2z\nYezZgOktx4nrzyV7GL2cRg/XFU8ZUQKmQXzCKBjuv7pRnIdvZ8dMemwaGI6kBhHJ\ngnHUFrDnyivTeZsJ1Gzcrjc01wHhLk61HAcgzHR10+w9PVGHQ44Tuks+ruZyfZuq\nXtWtIevLS9IyYPl8pHo4X60DV5iW2MOGRsFJsOzBAoGBAL166eSpgi/pl/ImOBRB\nU/4UKSJzhYVoH5tCeBouDAVttp4LhPwgloJq0xZE2yTZ5CWc5q93tOj88cMjzV5v\nQS6tVxk4VwyYn7SnS+G9CTZ2xteiRZNOz8i4HUbnTn1NDHsNu3PSxE5N7hbTbQZ+\nrJOCQkLiMhmSV2dCglIViJHF\n-----END PRIVATE KEY-----\n",
              "client_email": "content-owner@contrib-dev.iam.gserviceaccount.com",
              "client_id": "105786523305870671291",
              "auth_uri": "https://accounts.google.com/o/oauth2/auth",
              "token_uri": "https://oauth2.googleapis.com/token",
              "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
              "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/content-owner%40contrib-dev.iam.gserviceaccount.com",
            }

      # Build and push image to Google Container Registry
      - name: Docker Auth
        run: gcloud auth configure-docker

      - name: Build Docker Image
        run: docker build -t gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA .

      - name: Docker Push to Google Cloud
        run: docker push gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA

      # Deploy image to Cloud Run
      - name: Deploy
        run: >-
          gcloud run deploy $SERVICE_NAME
          --image=gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA
          --cpu=1
          --memory=1Gi
          --platform=managed
          --region=us-central1
          --allow-unauthenticated
          --port=3000
          --set-env-vars="^ ___^NEW_RELIC_APP_NAME=$ENV_NEW_RELIC_APP_NAME
          ___NEW_RELIC_LICENSE_KEY=$ENV_NEW_RELIC_LICENSE_KEY
          ___NEW_RELIC_DISTRIBUTED_TRACING_ENABLED=true
          ___MONGODB_URI=$ENV_MONGODB_URI
          ___APP_URL=$ENV_APP_URL
          ___AUTH_API_URL=$ENV_AUTH_API_URL
          ___GOOGLE_CLIENT_ID=$ENV_GOOGLE_CLIENT_ID
          ___GOOGLE_CLIENT_SECRET=$ENV_GOOGLE_CLIENT_SECRET
          ___FACEBOOK_APP_ID=$ENV_FACEBOOK_APP_ID
          ___FACEBOOK_APP_SECRET=$ENV_FACEBOOK_APP_SECRET
          ___TWITTER_CONSUMER_KEY=$ENV_TWITTER_CONSUMER_KEY
          ___TWITTER_CONSUMER_SECRET=$ENV_TWITTER_CONSUMER_SECRET
          ___COOKIE_KEY_SECRET=$ENV_COOKIE_KEY_SECRET
          ___COOKIE_LIFE_TIME_MINS=$ENV_COOKIE_LIFE_TIME_MINS
          ___TWILIO_ACCOUNT_SID=$ENV_TWILIO_ACCOUNT_SID
          ___TWILIO_AUTH_TOKEN=$ENV_TWILIO_AUTH_TOKEN
          ___TWILIO_VERIFICATION_SERVICE_SID=$ENV_TWILIO_VERIFICATION_SERVICE_SID
          ___TWILIO_SENDER_NUMBER=$ENV_TWILIO_SENDER_NUMBER
          ___CONTENT_STORAGE_NAME=$ENV_CONTENT_STORAGE_NAME
          ___CONTENT_STORAGE_KEY=$ENV_CONTENT_STORAGE_KEY
          ___UPS_DELIVERY_CONTRIB_DATA=$ENV_UPS_DELIVERY_CONTRIB_DATA
          ___UPS_TEST_ENVIROMENT=$ENV_UPS_TEST_ENVIROMENT
          ___UPS_SMS_WITH_DELIVERY_LINK=$ENV_UPS_SMS_WITH_DELIVERY_LINK
          ___UPS_AUCTION_DEFAULT_PARCEL_PARAMETERS=$ENV_UPS_AUCTION_DEFAULT_PARCEL_PARAMETERS
          ___UPS_DELIVERY_REQUEST_HEADER=$ENV_UPS_DELIVERY_REQUEST_HEADER
          ___AUCTION_SCHEDULER_SECRET=$ENV_AUCTION_SCHEDULER_SECRET
          ___CLOUDFLARE_STREAMING_KEY=$ENV_CLOUDFLARE_STREAMING_KEY
          ___CLOUDFLARE_USER_ID=$ENV_CLOUDFLARE_USER_ID
          ___STRIPE_SECRET_KEY=$ENV_STRIPE_SECRET_KEY
          ___STRIPE_WEBHOOK_SECRET_KEY=$ENV_STRIPE_WEBHOOK_SECRET_KEY
          ___STRIPE_CONTRIB_SHARE_PERCENTAGE=$ENV_STRIPE_CONTRIB_SHARE_PERCENTAGE
          ___MAX_SIZE_VIDEO_GB=$ENV_MAX_SIZE_VIDEO_GB
          ___GOOGLE_CLOUD_PROJECT=$ENV_GOOGLE_CLOUD_PROJECT
          ___GOOGLE_CLOUD_LOCATION=$ENV_GOOGLE_CLOUD_LOCATION
          ___GOOGLE_CLOUD_TASK_QUEUE=$ENV_GOOGLE_CLOUD_TASK_QUEUE
          ___GOOGLE_CLOUD_TASK_API_TOKEN=$ENV_GOOGLE_CLOUD_TASK_API_TOKEN
          ___NOTIFICATION_TASK_TARGET_URL=$ENV_NOTIFICATION_TASK_TARGET_URL"
