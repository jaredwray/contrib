name: deploy-to-live

on:
  release:
    types: [released]

env:
  PROJECT_ID: ${{ secrets.LIVE_GCP_PROJECT_ID }}
  SERVICE_NAME: contrib-app

  #Server Env
  ENV_NEW_RELIC_APP_NAME: contrib-app-live
  ENV_NEW_RELIC_LICENSE_KEY: ${{ secrets.NEW_RELIC_LICENSE_KEY }}
  ENV_MONGODB_URI: ${{ secrets.LIVE_MONGODB_URI }}
  ENV_AUTH0_ISSUER_URL: https://contrib.us.auth0.com/
  ENV_AUTH0_AUDIENCE: https://contrib.org
  ENV_AUTH0_MANAGEMENT_DOMAIN: contrib.us.auth0.com
  ENV_AUTH0_MANAGEMENT_CLIENT_ID: dj4DaWeggmOb7cbCOSxzSQAN5EYBwVqr
  ENV_AUTH0_MANAGEMENT_CLIENT_SECRET: ${{ secrets.LIVE_AUTH0_MANAGEMENT_CLIENT_SECRET }}
  ENV_TWILIO_ACCOUNT_SID: ACd64357f20d26725ac0b45616048e8d84
  ENV_TWILIO_AUTH_TOKEN: ${{ secrets.LIVE_TWILIO_AUTH_TOKEN }}
  ENV_TWILIO_VERIFICATION_SERVICE_SID: ${{ secrets.LIVE_TWILIO_VERIFICATION_SERVICE_SID }}
  ENV_APP_URL: "https://contrib.org/"
  ENV_TWILIO_SENDER_NUMBER: +17726178791
  ENV_CONTENT_STORAGE_NAME: content-live.contrib.org
  ENV_CONTENT_STORAGE_KEY: ${{ secrets.LIVE_CONTENT_STORAGE_KEY }}
  ENV_UPS_DELIVERY_REQUEST_HEADER: ${{ secrets.LIVE_UPS_DELIVERY_REQUEST_HEADER }}
  ENV_UPS_DELIVERY_CONTRIB_DATA: ${{ secrets.LIVE_UPS_DELIVERY_CONTRIB_DATA }}
  ENV_UPS_TEST_ENVIROMENT: false
  ENV_UPS_SMS_WITH_DELIVERY_LINK: false
  ENV_UPS_AUCTION_DEFAULT_PARCEL_PARAMETERS: ${{ secrets.LIVE_UPS_AUCTION_DEFAULT_PARCEL_PARAMETERS }}
  ENV_AUCTION_SCHEDULER_SECRET: ${{ secrets.LIVE_AUCTION_SCHEDULER_SECRET }}
  ENV_CLOUDFLARE_STREAMING_KEY: ${{ secrets.LIVE_CLOUDFLARE_STREAMING_KEY }}
  ENV_CLOUDFLARE_USER_ID: ${{ secrets.LIVE_CLOUDFLARE_USER_ID }}
  ENV_BITLY_DOMAIN: go.contrib.org
  ENV_BITLY_ACCESS_TOKEN: ${{ secrets.LIVE_BITLY_ACCESS_TOKEN }}
  ENV_STRIPE_SECRET_KEY: ${{ secrets.LIVE_STRIPE_SECRET_KEY }}
  ENV_STRIPE_WEBHOOK_SECRET_KEY: ${{ secrets.LIVE_STRIPE_WEBHOOK_SECRET_KEY }}
  ENV_STRIPE_CONTRIB_SHARE_PERCENTAGE: ${{ secrets.LIVE_STRIPE_CONTRIB_SHARE_PERCENTAGE }}
  ENV_FACEBOOK_APP_ID: 247741353494875
  ENV_GOOGLE_CLOUD_PROJECT: contrib-live
  ENV_GOOGLE_CLOUD_LOCATION: us-central1
  ENV_GOOGLE_CLOUD_TASK_QUEUE: bids-notification
  ENV_GOOGLE_CLOUD_TASK_API_TOKEN: ${{ secrets.LIVE_GOOGLE_CLOUD_TASK_API_TOKEN }}
  ENV_NOTIFICATION_TASK_TARGET_URL: api/v1/notification
  ENV_UPS_AUCTION_DEFAULT_PARCEL_PARAMETERS: {"width":"1", "length":"1", "height":"1", "weight":"1", "units":"imperial"}
  ENV_UPS_DELIVERY_CONTRIB_DATA: {"address":"524 9th Ave", "city":"Kirkland", "state":"WA", "zipCode":"98033", "shipperNumber":"3W090X"}
  ENV_UPS_DELIVERY_REQUEST_HEADER: ${{ secrets.UPS_DELIVERY_REQUEST_HEADER }}

jobs:
  setup-build-deploy:
    name: Build and Deploy to Dev
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      # Setup Node
      - name: Use Node.js 14
        uses: actions/setup-node@v1
        with:
          node-version: 14

      # Build Client
      - name: Build Client
        run: yarn build-client
        env:
          REACT_APP_AUTH0_DOMAIN: "contrib.us.auth0.com"
          REACT_APP_AUTH0_CLIENT_ID: JnjIWUhKdxPyceH48ZEZopVMKEPdT4E4
          REACT_APP_PLATFORM_URL: "https://contrib.org/"
          REACT_APP_API_URL: "https://contrib.org/graphql"
          REACT_APP_API_AUDIENCE: "https://contrib.org"
          REACT_APP_USE_NEWRELIC: true
          REACT_APP_NEWRELIC_LICENSE_KEY: ${{ secrets.NEW_RELIC_LICENSE_KEY }}
          REACT_APP_NEWRELIC_APPLICATION_ID: "916719636"
          REACT_APP_NEWRELIC_ACCOUNT_ID: "2921752"
          REACT_APP_STRIPE_PUBLISHABLE_KEY: ${{ secrets.LIVE_REACT_APP_STRIPE_PUBLISHABLE_KEY }}
          REACT_APP_INTERCOM_APP_ID: ${{ secrets.LIVE_REACT_APP_INTERCOM_APP_ID }}
          REACT_APP_FULLSTORY_ORG_ID: ${{ secrets.LIVE_REACT_APP_FULLSTORY_ORG_ID }}
          REACT_APP_MAX_SIZE_VIDEO_GB: "1"
          REACT_APP_GOOGLE_ANALYTICS_APP_ID: "G-T3VD43X4L3"
          REACT_APP_SMARTLOOK_ID: ${{ secrets.LIVE_REACT_APP_SMARTLOOK_ID }}
          REACT_APP_UPS_SHOW_LINK_ON_THE_AUCTION_PAGE: ${{ secrets.LIVE_REACT_APP_UPS_SHOW_LINK_ON_THE_AUCTION_PAGE }}
          REACT_APP_FIREBASE_CONFIG: ${{ secrets.LIVE_REACT_APP_FIREBASE_CONFIG }}

      # Test Client
      - name: Test Client
        run: yarn test-client

      # Build Server
      - name: Build Server
        run: yarn build-server

      # Test Server
      - name: Test Server
        run: yarn test-server

      - name: Code Coverage
        uses: codecov/codecov-action@v1.0.15
        with:
          token: ${{ secrets.CODECOV_KEY }}

      # Setup gcloud CLI
      - uses: google-github-actions/setup-gcloud@master
        with:
          service_account_key: ${{ secrets.LIVE_GCP_SA_KEY }}
          project_id: ${{ secrets.LIVE_GCP_PROJECT_ID }}
          export_default_credentials: true

      # Build and push image to Google Container Registry
      - name: Docker Auth
        run: gcloud auth configure-docker

      - name: Build Docker Image
        run: docker build -t gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA .

      - name: Docker Push to Google Cloud
        run: docker push gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA

      # Deploy image to Cloud Run
      - name: Deploy to US-Central1
        run: >-
          gcloud run deploy $SERVICE_NAME
          --image=gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA
          --cpu=1
          --memory=1Gi
          --platform=managed
          --region=us-central1
          --allow-unauthenticated
          --port=3000
          --set-env-vars="^ ___^NEW_RELIC_APP_NAME=$ENV_NEW_RELIC_APP_NAME
          ___NEW_RELIC_LICENSE_KEY=$ENV_NEW_RELIC_LICENSE_KEY
          ___MONGODB_URI=$ENV_MONGODB_URI
          ___APP_URL=$ENV_APP_URL
          ___TWILIO_ACCOUNT_SID=$ENV_TWILIO_ACCOUNT_SID
          ___TWILIO_AUTH_TOKEN=$ENV_TWILIO_AUTH_TOKEN
          ___TWILIO_VERIFICATION_SERVICE_SID=$ENV_TWILIO_VERIFICATION_SERVICE_SID
          ___TWILIO_SENDER_NUMBER=$ENV_TWILIO_SENDER_NUMBER
          ___AUTH0_ISSUER_URL=$ENV_AUTH0_ISSUER_URL
          ___AUTH0_AUDIENCE=$ENV_AUTH0_AUDIENCE
          ___AUTH0_MANAGEMENT_DOMAIN=$ENV_AUTH0_MANAGEMENT_DOMAIN
          ___AUTH0_MANAGEMENT_CLIENT_ID=$ENV_AUTH0_MANAGEMENT_CLIENT_ID
          ___AUTH0_MANAGEMENT_CLIENT_SECRET=$ENV_AUTH0_MANAGEMENT_CLIENT_SECRET
          ___CONTENT_STORAGE_NAME=$ENV_CONTENT_STORAGE_NAME
          ___CONTENT_STORAGE_KEY=$ENV_CONTENT_STORAGE_KEY
          ___UPS_DELIVERY_CONTRIB_DATA=$ENV_UPS_DELIVERY_CONTRIB_DATA
          ___UPS_TEST_ENVIROMENT=$ENV_UPS_TEST_ENVIROMENT
          ___UPS_SMS_WITH_DELIVERY_LINK=$ENV_UPS_SMS_WITH_DELIVERY_LINK
          ___UPS_AUCTION_DEFAULT_PARCEL_PARAMETERS=$ENV_UPS_AUCTION_DEFAULT_PARCEL_PARAMETERS
          ___UPS_DELIVERY_REQUEST_HEADER=$ENV_UPS_DELIVERY_REQUEST_HEADER
          ___AUCTION_SCHEDULER_SECRET=$ENV_AUCTION_SCHEDULER_SECRET
          ___CLOUDFLARE_STREAMING_KEY=$ENV_CLOUDFLARE_STREAMING_KEY
          ___CLOUDFLARE_USER_ID=$ENV_CLOUDFLARE_USER_ID
          ___BITLY_ACCESS_TOKEN=$ENV_BITLY_ACCESS_TOKEN
          ___STRIPE_SECRET_KEY=$ENV_STRIPE_SECRET_KEY
          ___STRIPE_WEBHOOK_SECRET_KEY=$ENV_STRIPE_WEBHOOK_SECRET_KEY
          ___STRIPE_CONTRIB_SHARE_PERCENTAGE=$ENV_STRIPE_CONTRIB_SHARE_PERCENTAGE
          ___BITLY_DOMAIN=$ENV_BITLY_DOMAIN
          ___FACEBOOK_APP_ID=$ENV_FACEBOOK_APP_ID
          ___GOOGLE_CLOUD_PROJECT=$ENV_GOOGLE_CLOUD_PROJECT
          ___GOOGLE_CLOUD_LOCATION=$ENV_GOOGLE_CLOUD_LOCATION
          ___GOOGLE_CLOUD_TASK_QUEUE=$ENV_GOOGLE_CLOUD_TASK_QUEUE
          ___GOOGLE_CLOUD_TASK_API_TOKEN=$ENV_GOOGLE_CLOUD_TASK_API_TOKEN
          ___UPS_AUCTION_DEFAULT_PARCEL_PARAMETERS=$ENV_UPS_AUCTION_DEFAULT_PARCEL_PARAMETERS
          ___UPS_DELIVERY_CONTRIB_DATA=$ENV_UPS_DELIVERY_CONTRIB_DATA
          ___UPS_DELIVERY_REQUEST_HEADER=$ENV_UPS_DELIVERY_REQUEST_HEADER
          ___NOTIFICATION_TASK_TARGET_URL=$ENV_NOTIFICATION_TASK_TARGET_URL"

      - name: Deploy to US-West1
        run: >-
          gcloud run deploy $SERVICE_NAME
          --image=gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA
          --cpu=1
          --memory=1Gi
          --platform=managed
          --region=us-west1
          --allow-unauthenticated
          --port=3000
          --set-env-vars="^ ___^NEW_RELIC_APP_NAME=$ENV_NEW_RELIC_APP_NAME
          ___NEW_RELIC_LICENSE_KEY=$ENV_NEW_RELIC_LICENSE_KEY
          ___NEW_RELIC_DISTRIBUTED_TRACING_ENABLED=true
          ___MONGODB_URI=$ENV_MONGODB_URI
          ___APP_URL=$ENV_APP_URL
          ___TWILIO_ACCOUNT_SID=$ENV_TWILIO_ACCOUNT_SID
          ___TWILIO_AUTH_TOKEN=$ENV_TWILIO_AUTH_TOKEN
          ___TWILIO_VERIFICATION_SERVICE_SID=$ENV_TWILIO_VERIFICATION_SERVICE_SID
          ___TWILIO_SENDER_NUMBER=$ENV_TWILIO_SENDER_NUMBER
          ___AUTH0_ISSUER_URL=$ENV_AUTH0_ISSUER_URL
          ___AUTH0_AUDIENCE=$ENV_AUTH0_AUDIENCE
          ___AUTH0_MANAGEMENT_DOMAIN=$ENV_AUTH0_MANAGEMENT_DOMAIN
          ___AUTH0_MANAGEMENT_CLIENT_ID=$ENV_AUTH0_MANAGEMENT_CLIENT_ID
          ___AUTH0_MANAGEMENT_CLIENT_SECRET=$ENV_AUTH0_MANAGEMENT_CLIENT_SECRET
          ___CONTENT_STORAGE_NAME=$ENV_CONTENT_STORAGE_NAME
          ___CONTENT_STORAGE_KEY=$ENV_CONTENT_STORAGE_KEY
          ___UPS_DELIVERY_CONTRIB_DATA=$ENV_UPS_DELIVERY_CONTRIB_DATA
          ___UPS_TEST_ENVIROMENT=$ENV_UPS_TEST_ENVIROMENT
          ___UPS_SMS_WITH_DELIVERY_LINK=$ENV_UPS_SMS_WITH_DELIVERY_LINK
          ___UPS_AUCTION_DEFAULT_PARCEL_PARAMETERS=$ENV_UPS_AUCTION_DEFAULT_PARCEL_PARAMETERS
          ___UPS_DELIVERY_REQUEST_HEADER=$ENV_UPS_DELIVERY_REQUEST_HEADER
          ___AUCTION_SCHEDULER_SECRET=$ENV_AUCTION_SCHEDULER_SECRET
          ___CLOUDFLARE_STREAMING_KEY=$ENV_CLOUDFLARE_STREAMING_KEY
          ___CLOUDFLARE_USER_ID=$ENV_CLOUDFLARE_USER_ID
          ___BITLY_ACCESS_TOKEN=$ENV_BITLY_ACCESS_TOKEN
          ___STRIPE_SECRET_KEY=$ENV_STRIPE_SECRET_KEY
          ___STRIPE_WEBHOOK_SECRET_KEY=$ENV_STRIPE_WEBHOOK_SECRET_KEY
          ___STRIPE_CONTRIB_SHARE_PERCENTAGE=$ENV_STRIPE_CONTRIB_SHARE_PERCENTAGE
          ___BITLY_DOMAIN=$ENV_BITLY_DOMAIN
          ___FACEBOOK_APP_ID=$ENV_FACEBOOK_APP_ID
          ___GOOGLE_CLOUD_PROJECT=$ENV_GOOGLE_CLOUD_PROJECT
          ___GOOGLE_CLOUD_LOCATION=$ENV_GOOGLE_CLOUD_LOCATION
          ___GOOGLE_CLOUD_TASK_QUEUE=$ENV_GOOGLE_CLOUD_TASK_QUEUE
          ___GOOGLE_CLOUD_TASK_API_TOKEN=$ENV_GOOGLE_CLOUD_TASK_API_TOKEN
          ___NOTIFICATION_TASK_TARGET_URL=$ENV_NOTIFICATION_TASK_TARGET_URL"
